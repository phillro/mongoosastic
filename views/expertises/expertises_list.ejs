<script src="/js/jquery.treeview.js" type="text/javascript"></script>
<script src="/js/jquery.treeview.edit.js" type="text/javascript"></script>
<link rel="stylesheet" href="/css/jquery.treeview.css" />
<div>
    <div>
        <h2>Expertise List</h2>
    </div>
    <br>
        <div>
        </div>
    <br>
    <div>
        <div class="filters">
        </div>
        <div>
            <input name="root_expertise_name" id="root_expertise_name"/> <button id="add_root_expertise">Add Root Expertise</button>
        </div>
        <hr>
        <div id="tree_panel" style="float: left;margin-right: 100; padding-right:10px;border-right:1px solid;">
        <%-partial('expertise_tree',{expertises:expertises})%>
        </div>
        <div id="expertise_details" style="margin-top:10px;">

        </div>
    </div>
</div>
<script type="text/javascript">
	$(function() {

        function addExpertise(expertiseData,addExpertiseCallback){
            $.ajax({
              type: 'POST',
              url: '/expertises/save?ajax=true',
              data: expertiseData,
              success: function(data){
                  if(typeof addExpertiseCallback=='function')
                  addExpertiseCallback(data)
              }
            });
        }

        function getExpertise(expertiseId,callback){
            $.get('/expertises/show/'+expertiseId+'?ajax=true',function(data){

                $('.add_child_expertise_button').click(function(){
                    var parentId=this.id.replace('add_child_expertise_','')
                        var expertise= {
                            parentId:parentId,
                            name:$('#child_expertise_name').val()
                        }
                        addExpertise(expertise,function(addResponse){
                            refreshExpertiseTree()
                        })
                })
                if(typeof callback=='function')
                callback(data)
            })
        }



        function refreshExpertiseTree(callback){
            $.get('/expertises/list?ajax=true',function(data){
                $('#tree_panel').empty();
                $('#tree_panel').html(data)
                $('.expertise_node').click(function(){
                            var expertiseId=this.id.replace('expertise_node_','')
                            getExpertise(expertiseId,function(data){

                            })
                                $.get('/expertises/show/'+expertiseId+'?ajax=true',function(data){
                                    $('#expertise_details').html(data)
                                })
                        })

                        $('#add_root_expertise').click(function () {
                            var data = {
                                name:$('#root_expertise_name').val()
                            }
                            addExpertise(data,function(){
                                refreshExpertiseTree()
                            })
                        })
                if(typeof callback=='function')
                callback(data)
            })
        }

        refreshExpertiseTree()


    });
</script>
